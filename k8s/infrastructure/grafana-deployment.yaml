# EZ Platform Grafana - Kubernetes Deployment
# Unified visualization and dashboards for system and business metrics

---
# Grafana credentials Secret
# NOTE: For production, replace with externally managed secrets (e.g., Vault, sealed-secrets)
apiVersion: v1
kind: Secret
metadata:
  name: grafana-credentials
  namespace: ez-platform
  labels:
    app: ezplatform-grafana
type: Opaque
stringData:
  admin-password: "admin"  # TODO: Change for production deployment

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources-config
  namespace: ez-platform
data:
  datasources.yaml: |
    apiVersion: 1
    datasources:
      # System Prometheus - Infrastructure Metrics
      - name: System-Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-system:9090
        isDefault: false
        editable: false
        uid: system-prometheus-uid
        jsonData:
          timeInterval: 15s
          queryTimeout: 60s
          httpMethod: POST
        version: 1

      # Business Prometheus - Business KPIs
      - name: Business-Prometheus
        type: prometheus
        access: proxy
        url: http://prometheus-business:9090
        isDefault: true
        editable: false
        uid: business-prometheus-uid
        jsonData:
          timeInterval: 1m
          queryTimeout: 60s
          httpMethod: POST
        version: 1

      # Elasticsearch - Logs
      - name: Elasticsearch-Logs
        type: elasticsearch
        access: proxy
        url: http://elasticsearch:9200
        database: dataprocessing-logs-*
        isDefault: false
        editable: false
        uid: elasticsearch-logs-uid
        jsonData:
          index: dataprocessing-logs
          interval: Daily
          timeField: "@timestamp"
          esVersion: "8.0.0"
          logMessageField: message
          logLevelField: level
        version: 1

---
apiVersion: v1
kind: Service
metadata:
  name: ezplatform-grafana
  namespace: ez-platform
  labels:
    app: ezplatform-grafana
spec:
  type: LoadBalancer
  ports:
  - port: 3000
    targetPort: 3000
    name: http
  selector:
    app: ezplatform-grafana

---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: ezplatform-grafana
  namespace: ez-platform
  labels:
    app: ezplatform-grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: ezplatform-grafana
  template:
    metadata:
      labels:
        app: ezplatform-grafana
        component: monitoring
    spec:
      containers:
      - name: ezplatform-grafana
        image: grafana/grafana:latest
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: GF_SECURITY_ADMIN_PASSWORD
          valueFrom:
            secretKeyRef:
              name: grafana-credentials
              key: admin-password
        - name: GF_USERS_ALLOW_SIGN_UP
          value: "false"
        resources:
          requests:
            cpu: "250m"
            memory: "512Mi"
          limits:
            cpu: "1000m"
            memory: "2Gi"
        volumeMounts:
        - name: grafana-data
          mountPath: /var/lib/grafana
        - name: grafana-datasources
          mountPath: /etc/grafana/provisioning/datasources
        - name: grafana-dashboards-provider
          mountPath: /etc/grafana/provisioning/dashboards/dashboards.yaml
          subPath: dashboards.yaml
        - name: grafana-business-dashboard
          mountPath: /etc/grafana/provisioning/dashboards/business-metrics.json
          subPath: business-metrics.json
      volumes:
      - name: grafana-data
        persistentVolumeClaim:
          claimName: ezplatform-grafana-data-pvc
      - name: grafana-datasources
        configMap:
          name: grafana-datasources-config
      - name: grafana-dashboards-provider
        configMap:
          name: grafana-dashboards-provider
      - name: grafana-business-dashboard
        configMap:
          name: grafana-business-metrics-dashboard

---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: ezplatform-grafana-data-pvc
  namespace: ez-platform
spec:
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi
  storageClassName: standard
