{{- if .Values.hazelcast.enabled }}
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: hazelcast-config
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "ez-platform.labels" . | nindent 4 }}
    app: hazelcast
    component: cache
data:
  hazelcast.yaml: |
    hazelcast:
      cluster-name: {{ .Values.hazelcast.clusterName | default "data-processing-cluster" }}
      network:
        join:
          kubernetes:
            enabled: true
            namespace: {{ .Values.global.namespace }}
            service-name: hazelcast-service
      map:
        # File content cache - stores raw file data temporarily
        file-content:
          time-to-live-seconds: {{ .Values.hazelcast.maps.fileContent.ttlSeconds | default 300 }}
          max-idle-seconds: {{ .Values.hazelcast.maps.fileContent.maxIdleSeconds | default 180 }}
          eviction:
            eviction-policy: LRU
            max-size-policy: USED_HEAP_SIZE
            size: {{ .Values.hazelcast.maps.fileContent.maxSizeMB | default 256 }}
          backup-count: {{ .Values.hazelcast.maps.fileContent.backupCount | default 0 }}

        # Valid records cache - stores validated data temporarily
        valid-records:
          time-to-live-seconds: {{ .Values.hazelcast.maps.validRecords.ttlSeconds | default 300 }}
          max-idle-seconds: {{ .Values.hazelcast.maps.validRecords.maxIdleSeconds | default 180 }}
          eviction:
            eviction-policy: LRU
            max-size-policy: USED_HEAP_SIZE
            size: {{ .Values.hazelcast.maps.validRecords.maxSizeMB | default 256 }}
          backup-count: {{ .Values.hazelcast.maps.validRecords.backupCount | default 0 }}

        # File deduplication cache - stores file hashes
        file-hashes:
          time-to-live-seconds: {{ .Values.hazelcast.maps.fileHashes.ttlSeconds | default 14400 }}
          max-idle-seconds: {{ .Values.hazelcast.maps.fileHashes.maxIdleSeconds | default 7200 }}
          eviction:
            eviction-policy: LRU
            max-size-policy: USED_HEAP_SIZE
            size: {{ .Values.hazelcast.maps.fileHashes.maxSizeMB | default 128 }}
          backup-count: {{ .Values.hazelcast.maps.fileHashes.backupCount | default 0 }}

---
apiVersion: v1
kind: Service
metadata:
  name: hazelcast-service
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "ez-platform.labels" . | nindent 4 }}
    app: hazelcast
    component: cache
spec:
  ports:
  - port: 5701
    targetPort: 5701
    name: hazelcast
  clusterIP: None  # Headless service
  selector:
    app: hazelcast

---
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: hazelcast
  namespace: {{ .Values.global.namespace }}
  labels:
    {{- include "ez-platform.labels" . | nindent 4 }}
    app: hazelcast
    component: cache
spec:
  serviceName: hazelcast-service
  replicas: {{ .Values.hazelcast.replicas }}
  selector:
    matchLabels:
      app: hazelcast
  template:
    metadata:
      labels:
        app: hazelcast
        component: cache
    spec:
      containers:
      - name: hazelcast
        image: {{ .Values.hazelcast.image | default "hazelcast/hazelcast:5.6" }}
        ports:
        - containerPort: 5701
          name: hazelcast
        env:
        - name: JAVA_OPTS
          value: {{ printf "-Xms%s -Xmx%s -Dhazelcast.config=/config/hazelcast.yaml" .Values.hazelcast.jvm.minMemory .Values.hazelcast.jvm.maxMemory | quote }}
        - name: HZ_NETWORK_RESTAPI_ENABLED
          value: "true"
        - name: HZ_CLUSTERNAME
          value: {{ .Values.hazelcast.clusterName | default "data-processing-cluster" | quote }}
        - name: HZ_KUBERNETES_NAMESPACE
          valueFrom:
            fieldRef:
              fieldPath: metadata.namespace
        - name: HZ_KUBERNETES_SERVICE_NAME
          value: "hazelcast-service"
        {{- with .Values.hazelcast.extraEnv }}
        {{- toYaml . | nindent 8 }}
        {{- end }}
        resources:
          {{- toYaml .Values.hazelcast.resources | nindent 10 }}
        volumeMounts:
        - name: hazelcast-config
          mountPath: /config
        - name: hazelcast-data
          mountPath: /data
        livenessProbe:
          httpGet:
            path: /hazelcast/health/node-state
            port: 5701
          initialDelaySeconds: {{ .Values.hazelcast.livenessProbe.initialDelaySeconds | default 60 }}
          periodSeconds: {{ .Values.hazelcast.livenessProbe.periodSeconds | default 10 }}
        readinessProbe:
          httpGet:
            path: /hazelcast/health/ready
            port: 5701
          initialDelaySeconds: {{ .Values.hazelcast.readinessProbe.initialDelaySeconds | default 30 }}
          periodSeconds: {{ .Values.hazelcast.readinessProbe.periodSeconds | default 5 }}
      volumes:
      - name: hazelcast-config
        configMap:
          name: hazelcast-config
  volumeClaimTemplates:
  - metadata:
      name: hazelcast-data
    spec:
      accessModes: [ "ReadWriteOnce" ]
      resources:
        requests:
          storage: {{ .Values.hazelcast.storage }}
      storageClassName: {{ .Values.hazelcast.storageClass }}
{{- end }}
