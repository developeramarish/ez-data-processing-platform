# RTL Technical Fields Fix Plan - Critical Issue

**Issue Discovered:** October 27, 2025  
**Severity:** HIGH - Affects data validation  
**Impact:** Regex patterns reversed in RTL layout, causing validation failures

---

## üêõ Bug Description

### The Problem

When the UI is in Hebrew RTL mode, **technical fields like regex patterns are being reversed character-by-character**, making them invalid.

**Example from reportDate field:**
```
Correct pattern:  ^[0-9]{4}-[0-9]{2}-[0-9]{2}$  (YYYY-MM-DD)
Displayed in RTL: ${2}[0-9]-{2}[0-9]-{4}[0-9]-${  (REVERSED!)
Validation:       ‚ùå FAILS - Invalid pattern
```

### Root Cause

The global RTL directive (`direction: rtl`) is being applied to **all text inputs**, including those that should always be LTR:
- Regex patterns
- JSON code
- Code expressions
- PromQL queries
- Cron expressions  
- URLs
- File paths
- Connection strings

---

## üîç Affected Areas - System-Wide Audit

### 1. Schema Management ‚ö†Ô∏è CRITICAL

**Fields Affected:**
- ‚úÖ **Pattern field** (regex) - In jsonjoy builder and Monaco editor
- ‚úÖ **minLength/maxLength** - Numeric, less critical
- ‚úÖ **Enum values** - May contain technical values
- ‚úÖ **Examples field** - May contain technical examples
- ‚úÖ **Custom validation expressions**

**Impact:** 
- Regex patterns validate incorrectly
- Generated examples fail validation
- Schema becomes unusable

### 2. Metrics Configuration ‚ö†Ô∏è HIGH

**Fields Affected:**
- ‚úÖ **PromQL expressions** - Alert rules and custom formulas
- ‚úÖ **Formula field** - MongoDB aggregation syntax
- ‚úÖ **Label names/values** - Prometheus naming conventions
- ‚úÖ **Field paths** - Dot notation (e.g., `revenue.total`)

**Impact:**
- Alert rules won't trigger correctly
- Formulas won't execute
- Metrics won't push to Prometheus

### 3. Data Sources Configuration ‚ö†Ô∏è MEDIUM

**Fields Affected:**
- ‚úÖ **Connection strings** - MongoDB, SQL, etc.
- ‚úÖ **File paths** - Local and SFTP paths
- ‚úÖ **URLs** - HTTP endpoints
- ‚úÖ **Cron expressions** - Schedule patterns
- ‚úÖ **Kafka brokers** - host:port lists
- ‚ö†Ô∏è **Configuration JSON** - Embedded JSON configs

**Impact:**
- Connection testing may fail
- Scheduling won't work correctly
- File paths invalid

### 4. AI Assistant & Queries ‚ö†Ô∏è HIGH

**Fields Affected:**
- ‚úÖ **PromQL queries** generated by AI
- ‚úÖ **MongoDB queries** for metrics
- ‚úÖ **Code snippets** in responses
- ‚úÖ **JSON examples**

---

## üõ†Ô∏è Fix Strategy

### Solution: Force LTR on Technical Fields

Add `direction: ltr` CSS property to specific input components that should never be RTL.

### Implementation Pattern

```tsx
// Pattern 1: Inline style for single fields
<Input 
  style={{ direction: 'ltr', textAlign: 'left' }}
  placeholder="^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
/>

// Pattern 2: CSS class for reusable components
<Input 
  className="ltr-field"
  placeholder="mongodb://localhost:27017"
/>

// Pattern 3: Ant Design ConfigProvider
<ConfigProvider direction="ltr">
  <MonacoEditor />
</ConfigProvider>
```

### CSS Class Definition

```css
/* src/Frontend/src/index.css or App.css */

/* Force LTR for technical fields */
.ltr-field,
.ltr-field input,
.ltr-field textarea,
.ltr-field .ant-input,
.ltr-field .ant-input-affix-wrapper {
  direction: ltr !important;
  text-align: left !important;
}

/* Code editors should always be LTR */
.monaco-editor,
.jsonjoy-builder,
code, pre, 
.ant-typography-code {
  direction: ltr !important;
  text-align: left !important;
}

/* Preserve Hebrew text capability in descriptions */
.ltr-field::placeholder {
  direction: rtl;
  text-align: right;
}
```

---

## üìã Complete Fix Checklist

### Schema Management Fields

**Schema Builder:**
- [ ] Pattern field (regex input)
- [ ] MinLength/MaxLength inputs
- [ ] Format field
- [ ] Enum values input
- [ ] Examples field
- [ ] Default value (if technical)
- [ ] Custom validation expressions

**Monaco Editor:**
- [x] Already LTR (verified working)

**Templates:**
- [ ] Template JSON content
- [ ] Template examples

### Metrics Configuration Fields

**Wizard:**
- [ ] Field path input (Step 2)
- [ ] Formula field (if added)
- [ ] PromQL expression (Step 5 - AlertRuleBuilder)
- [ ] Label names input (Step 4)
- [ ] Label values (if technical, e.g., metric names)
- [ ] Alert expression field

**Helper Dialogs:**
- [ ] PromQLExpressionHelperDialog - expression input
- [ ] FormulaBuilder - formula input
- [ ] FilterConditionBuilder - field paths

### Data Sources Fields

**Connection Tab:**
- [ ] Connection host
- [ ] File path (SFTP/FTP/Local)
- [ ] URL field (HTTP)
- [ ] Kafka brokers
- [ ] Kafka topic name
- [ ] Kafka consumer group
- [ ] Connection username (can be email)
- ‚ö†Ô∏è Connection password (already hidden, less critical)

**File Settings Tab:**
- [ ] CSV delimiter (single char, less critical)
- [ ] Excel sheet name (may contain Hebrew, keep RTL?)
- [ ] Encoding selector (values are technical)

**Schedule Tab:**
- [ ] Cron expression input ‚≠ê CRITICAL
- [x] Cron preview (Hebrew, keep RTL)

**Embedded Schema Tab:**
- [ ] All schema fields (same as Schema Management above)

### AI Assistant

**Chat Interface:**
- [ ] Code blocks in responses (use `<code>` tag with LTR class)
- [ ] JSON examples
- [ ] Query examples

### Shared Components

**Cron Helper Dialog:**
- [ ] Cron expression input
- [ ] Expression preview (can stay RTL for Hebrew explanation)

---

## üéØ Priority Levels

### P0 - CRITICAL (Fix Immediately)
1. **Regex pattern fields** in Schema Builder
2. **Cron expression fields** in Schedule Tab
3. **PromQL expressions** in Metrics AlertRuleBuilder
4. **File paths** and **URLs** in Connection Tab

### P1 - HIGH (Fix Soon)
1. **Formula fields** in Metrics
2. **Field paths** in Metrics (dot notation)
3. **Kafka brokers** and connection strings
4. **Label names** in Metrics (Prometheus naming)
5. **Code snippets** in AI Assistant responses

### P2 - MEDIUM (Fix Eventually)
1. Enum values (if technical)
2. Examples fields (if technical)
3. Configuration JSON fields
4. MongoDB query strings

---

## üìù Implementation Files to Modify

### Schema Management

**1. SchemaBuilderNew.tsx**
```tsx
// Force LTR on pattern input in jsonjoy builder
// May require custom CSS or wrapper component
```

**2. jsonjoy builder configuration**
```tsx
// Check if jsonjoy-builder has prop for field directionality
// If not, wrap in ConfigProvider or add CSS
```

### Metrics Configuration

**3. AlertRuleBuilder.tsx**
```tsx
<Input
  value={parameters['expression']}
  onChange={(e) => handleParameterChange('expression', e.target.value)}
  className="ltr-field" // ADD THIS
  placeholder="metric_name > 100"
/>
```

**4. PromQLExpressionHelperDialog.tsx**
```tsx
<TextArea
  value={expression}
  onChange={(e) => setExpression(e.target.value)}
  className="ltr-field" // ADD THIS
  rows={4}
/>
```

**5. WizardStepField.tsx**
```tsx
// Field path selector - force LTR for dot notation
<Input
  className="ltr-field"
  placeholder="revenue.total.amount"
/>
```

**6. EnhancedLabelInput.tsx**
```tsx
// Label names and technical values
<Input
  className="ltr-field"
  placeholder="status, region, env"
/>
```

### Data Sources

**7. ConnectionTab.tsx**
```tsx
// Host, URL, Path fields
<Input
  name="connectionHost"
  className="ltr-field"
  placeholder="ftp.example.com"
/>

<Input
  name="connectionUrl"
  className="ltr-field"
  placeholder="https://api.example.com"
/>

<Input
  name="connectionPath"
  className="ltr-field"
  placeholder="/path/to/files/"
/>

// Kafka fields
<TextArea
  name="kafkaBrokers"
  className="ltr-field"
  placeholder="localhost:9092,broker2:9092"
/>

<Input
  name="kafkaTopic"
  className="ltr-field"
  placeholder="data-events"
/>
```

**8. ScheduleTab.tsx**
```tsx
<Input
  name="cronExpression"
  className="ltr-field" // ADD THIS
  placeholder="0 0 * * *"
/>
```

**9. CronHelperDialog.tsx**
```tsx
<Input
  value={cronExpression}
  className="ltr-field"
  onChange={...}
/>
```

---

## üé® Recommended Global CSS

**File:** `src/Frontend/src/App.css` or `src/Frontend/src/index.css`

```css
/* ==============================================
   LTR Technical Fields Override for RTL Layout
   ============================================== */

/* General technical field class */
.ltr-field,
.ltr-field input,
.ltr-field textarea,
.ltr-field .ant-input,
.ltr-field .ant-input-affix-wrapper,
.ltr-field .ant-input-number,
.ltr-field .ant-select-selection-search-input {
  direction: ltr !important;
  text-align: left !important;
  font-family: 'Courier New', Consolas, monospace !important;
}

/* Code editors */
.monaco-editor,
.jsonjoy-builder,
.json-editor,
.code-editor {
  direction: ltr !important;
}

/* Code blocks and inline code */
code, pre,
.ant-typography-code,
.ant-typography-pre {
  direction: ltr !important;
  text-align: left !important;
  font-family: 'Courier New', Consolas, monospace !important;
}

/* PromQL and formula fields */
.promql-field,
.formula-field,
.expression-field {
  direction: ltr !important;
  text-align: left !important;
  font-family: 'Courier New', Consolas, monospace !important;
}

/* Preserve RTL for placeholders (if they're in Hebrew) */
.ltr-field input::placeholder,
.ltr-field textarea::placeholder {
  direction: rtl;
  text-align: right;
}
```

---

## üîÑ Testing Plan After Fix

### 1. Schema Management Testing
- [ ] Create schema with regex pattern `^[0-9]{4}-[0-9]{2}-[0-9]{2}$`
- [ ] Generate JSON example
- [ ] Verify pattern displays correctly (LTR)
- [ ] Verify validation passes
- [ ] Check example generates valid date

### 2. Metrics Configuration Testing
- [ ] Create metric with PromQL alert expression
- [ ] Verify expression displays LTR
- [ ] Save and reload - pattern should remain LTR
- [ ] Test PromQL Expression Helper dialog

### 3. Data Sources Testing
- [ ] Enter cron expression `0 */4 * * *`
- [ ] Verify displays LTR
- [ ] Verify humanized preview works
- [ ] Test file paths with slashes
- [ ] Test URLs with protocols

### 4. Visual Verification
- [ ] Hebrew field labels still display RTL ‚úì
- [ ] Hebrew descriptions still display RTL ‚úì
- [ ] Technical values display LTR ‚úì
- [ ] Placeholders display appropriately
- [ ] Overall layout remains RTL ‚úì

---

## üìä Impact Assessment

### Severity: HIGH

**Affected Features:**
- Schema validation (regex patterns fail)
- Metrics alerts (PromQL expressions fail)
- Data source scheduling (cron expressions fail)
- File discovery (paths reversed)
- API connections (URLs broken)

**User Impact:**
- ‚ùå Cannot create functional schemas with regex
- ‚ùå Cannot set up alerts with PromQL
- ‚ùå Cannot configure proper schedules
- ‚ùå Connection testing may fail
- ‚ùå Example generation produces invalid data

### Estimated Fix Time

**Quick Fix (P0 fields only):** 2-3 hours
- Add LTR class to critical regex/cron/PromQL fields
- Test with existing data
- Verify no layout breaks

**Complete Fix (All technical fields):** 4-6 hours  
- Audit all 200+ form fields
- Classify as Hebrew-text vs Technical
- Apply LTR to all technical fields
- Comprehensive testing

**CSS Infrastructure:** 1 hour
- Create comprehensive CSS classes
- Document usage patterns
- Update component library

---

## üéØ Recommendation

### Immediate Action Required

1. **Add Global CSS** (30 minutes)
   - Create `.ltr-field` class with all variations
   - Add to App.css or index.css

2. **Fix P0 Fields** (2 hours)
   - Regex pattern inputs (SchemaBuilder, RegexHelper)
   - Cron expression inputs (ScheduleTab, CronHelper)
   - PromQL expression inputs (AlertRuleBuilder, PromQLHelper)
   - URL/Path fields (ConnectionTab)

3. **Test Critical Workflows** (30 minutes)
   - Create schema with regex
   - Create scheduled data source
   - Create metric with alert

4. **Fix P1 Fields** (2 hours)
   - All remaining technical fields
   - Formula builders
   - Label inputs
   - Connection strings

### Long-Term Strategy

**Create Technical Field Component:**

```tsx
// src/Frontend/src/components/common/TechnicalInput.tsx

import { Input, InputProps } from 'antd';
import { TextAreaProps } from 'antd/es/input';

interface TechnicalInputProps extends InputProps {
  technical?: boolean; // Force LTR
}

export const TechnicalInput: React.FC<TechnicalInputProps> = ({ 
  technical = true, 
  className, 
  ...props 
}) => {
  const finalClassName = technical 
    ? `ltr-field ${className || ''}` 
    : className;
    
  return (
    <Input 
      {...props} 
      className={finalClassName}
    />
  );
};

export const TechnicalTextArea: React.FC<TextAreaProps & { technical?: boolean }> = ({ 
  technical = true, 
  className, 
  ...props 
}) => {
  const finalClassName = technical 
    ? `ltr-field ${className || ''}` 
    : className;
    
  return (
    <Input.TextArea 
      {...props} 
      className={finalClassName}
    />
  );
};
```

**Usage:**
```tsx
// Instead of:
<Input placeholder="^[0-9]{4}-[0-9]{2}-[0-9]{2}$" />

// Use:
<TechnicalInput placeholder="^[0-9]{4}-[0-9]{2}-[0-9]{2}$" />
```

---

## üìö Field Classification Guide

### Always LTR (Technical Fields)
- Regex patterns
- PromQL expressions
- MongoDB queries
- Code snippets
- JSON content
- Cron expressions
- URLs and URIs
- File paths (Windows/Unix)
- Connection strings
- Kafka brokers/topics
- Email addresses (domain part)
- IP addresses
- Port numbers
- Version numbers
- UUIDs and IDs (if alphanumeric)
- SQL queries
- API endpoints
- Environment variables
- Label names (Prometheus)
- Metric names

### Can Be RTL (Human-Readable Text)
- Names and display names
- Descriptions
- Comments
- Error messages
- Help text
- Alert messages
- Notification text
- Log messages (if in Hebrew)
- User input (free text)

### Hybrid (Context-Dependent)
- Examples (check if technical or descriptive)
- Default values (check type)
- Enum values (check if technical constants or Hebrew labels)
- Tags (check if technical labels or Hebrew categories)

---

## üöÄ Implementation Steps

### Step 1: Add Global CSS (Immediate)
```bash
# Add to src/Frontend/src/App.css
cat >> src/Frontend/src/App.css << 'EOF'

/* LTR Technical Fields */
.ltr-field { direction: ltr !important; text-align: left !important; }
.ltr-field input { direction: ltr !important; text-align: left !important; }
.ltr-field textarea { direction: ltr !important; text-align: left !important; }
EOF
```

### Step 2: Fix Schema Management
1. Update SchemaBuilderNew.tsx - pattern inputs
2. Update RegexHelperDialog (if exists) - pattern input/tester
3. Test with existing schemas

### Step 3: Fix Metrics Configuration
1. Update AlertRuleBuilder.tsx - PromQL expression
2. Update PromQLExpressionHelperDialog.tsx - all inputs
3. Update EnhancedLabelInput.tsx - label names
4. Update WizardStepField.tsx - field path
5. Test metrics creation and alerts

### Step 4: Fix Data Sources
1. Update ConnectionTab.tsx - all technical fields
2. Update ScheduleTab.tsx - cron expression
3. Update CronHelperDialog.tsx - cron input
4. Test connection and scheduling

### Step 5: System-Wide Audit
1. Search for all `<Input` components
2. Classify each by field type
3. Add `className="ltr-field"` where appropriate
4. Test each modified component

---

## ‚úÖ Success Criteria

After fix implementation:

1. **Regex patterns** display and validate correctly
2. **Cron expressions** remain readable and functional
3. **PromQL queries** execute without errors
4. **File paths** navigate correctly
5. **URLs** open/connect properly
6. **Hebrew text** still displays RTL in descriptions
7. **Overall RTL layout** remains intact
8. **No visual regressions** in existing UI

---

## üìñ Documentation Updates

### Developer Guide Section

**Title:** "RTL Layout with Technical Fields"

**Content:**
```markdown
## Working with RTL Layout

The EZ Platform uses RTL (right-to-left) layout for Hebrew language support.
However, **technical fields must remain LTR** to function correctly.

### When to Use LTR

Always use `className="ltr-field"` for:
- Regex patterns
- Code expressions (PromQL, MongoDB, SQL)
- URLs, paths, connection strings
- Cron expressions
- Technical identifiers

### When to Use RTL

Keep RTL for:
- Field labels (Hebrew)
- Descriptions and help text
- User-entered Hebrew text
- Error messages

### Example

```tsx
// Good - Technical field with Hebrew label
<Form.Item label="◊™◊ë◊†◊ô◊™ Regex">
  <Input className="ltr-field" placeholder="^[0-9]+$" />
</Form.Item>

// Good - Hebrew text field
<Form.Item label="◊™◊ô◊ê◊ï◊®">
  <TextArea placeholder="◊î◊õ◊†◊° ◊™◊ô◊ê◊ï◊® ◊ë◊¢◊ë◊®◊ô◊™..." />
</Form.Item>
```
```

---

## üîÑ Testing Checklist

### Before Fix
- [x] Identified: Regex pattern reversed in Schema
- [x] Identified: Pattern `${2}[0-9]-{2}[0-9]-{4}[0-9]-${`
- [x] Identified: Validation fails with reversed pattern

### After Fix
- [ ] Regex displays LTR: `^[0-9]{4}-[0-9]{2}-[0-9]{2}$`
- [ ] Validation passes
- [ ] Example generation works
- [ ] Pattern editing works correctly
- [ ] Copy/paste pattern works
- [ ] Hebrew labels still RTL
- [ ] No layout breaks

---

## üìû Rollout Plan

### Phase 1: Hot Fix (Day 1)
- Add global `.ltr-field` CSS class
- Fix P0 critical fields (regex, cron, PromQL)
- Deploy to dev environment
- Quick smoke test

### Phase 2: Comprehensive Fix (Day 2-3)
- Fix all P1 and P2 fields
- Create TechnicalInput component
- Update documentation
- Comprehensive testing

### Phase 3: Future-Proofing (Week 2)
- Component library update
- Code review checklist item
- Automated testing for RTL issues
- Developer training

---

## üéì Lessons Learned

### What Went Wrong
- Global RTL applied without exceptions for technical fields
- No testing with actual technical content (only Hebrew text)
- Missing field classification (technical vs human-readable)
- No component library for technical inputs

### How to Prevent
1. **Field Classification** - Classify all inputs as Technical or Text
2. **Component Library** - Create TechnicalInput/TechnicalTextArea
3. **Testing** - Test with real regex/cron/PromQL before deployment
4. **Code Review** - Check for technical fields in new features
5. **Documentation** - Document when to use LTR vs RTL

---

## üö® Priority Action

**This is a BLOCKER for production deployment.**

**Recommendation:** 
1. Fix P0 fields immediately (2-3 hours)
2. Test critical workflows
3. Deploy hot fix
4. Schedule comprehensive fix for next sprint

**Without this fix:**
- Schemas with regex are broken
- Alerts won't trigger
- Scheduling won't work
- Data validation fails

**Estimated Total Fix Time:** 6-8 hours for complete solution

---

**Document Created:** October 27, 2025  
**Status:** Ready for implementation  
**Priority:** P0 - Critical

**Next Steps:**
1. Review this plan
2. Approve fix approach
3. Implement P0 fixes (2-3 hours)
4. Test and deploy
5. Schedule complete fix
